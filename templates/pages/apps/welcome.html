{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Header with Back Button -->
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <a href="/admin/apps" class="text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
            </a>
            <div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Welcome System</h1>
                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
                    Configure welcome messages for new members joining {{ guild.guild_name if guild else 'your server' }}
                </p>
            </div>
        </div>
        <div class="flex items-center space-x-3">
            <span class="text-sm text-gray-600 dark:text-gray-400">Status:</span>
            <span class="px-3 py-1 text-sm rounded-full {% if guild and guild.settings.get('welcome_enabled', True) %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200{% else %}bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200{% endif %}">
                {% if guild and guild.settings.get('welcome_enabled', True) %}Enabled{% else %}Disabled{% endif %}
            </span>
        </div>
    </div>

    <!-- Welcome Channel Configuration -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Welcome Channel</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
            Select the channel where the welcome message will be posted when new members join
        </p>

        <!-- Loading State -->
        <div id="channelLoadingState" class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
            <p class="text-sm text-gray-600 dark:text-gray-400">Loading channels from Discord...</p>
        </div>

        <!-- Channel Selection -->
        <div id="channelSelectionState" class="hidden">
            <div class="flex gap-3">
                <div class="flex-1">
                    <select
                        id="channelSelect"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        <option value="">-- Select a channel --</option>
                    </select>
                </div>
                <button
                    onclick="saveChannel()"
                    class="px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 whitespace-nowrap"
                >
                    Save Channel
                </button>
            </div>
            <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                Choose the channel where welcome messages will be posted
            </p>
        </div>

        <!-- Error/Manual State -->
        <div id="channelErrorState" class="hidden">
            <div class="p-4 border border-yellow-200 dark:border-yellow-800 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg mb-3">
                <p class="text-sm text-yellow-800 dark:text-yellow-200" id="channelErrorMessage"></p>
                <p class="text-xs text-yellow-600 dark:text-yellow-400 mt-1">
                    Make sure the bot is running and connected to Discord, then refresh the page.
                </p>
            </div>
            <div class="flex gap-3">
                <div class="flex-1">
                    <input
                        type="number"
                        id="channelIdInput"
                        placeholder="Enter Channel ID (e.g. 1234567890123456789)"
                        value="{{ welcome_channel.channel_id if welcome_channel else '' }}"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                <button
                    onclick="saveChannelManual()"
                    class="px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 whitespace-nowrap"
                >
                    Save Channel
                </button>
            </div>
            <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                Right-click a channel in Discord and select "Copy Channel ID"
            </p>
        </div>
    </div>

    <!-- Message Content Customization -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Message Content</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
            Customize the content and appearance of your welcome message
        </p>

        <!-- Message Type Selection -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Message Type
            </label>
            <div class="flex gap-4">
                <label class="flex items-center">
                    <input
                        type="radio"
                        name="messageType"
                        value="embed"
                        id="messageTypeEmbed"
                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                        {% if not guild or not guild.settings.get('welcome_message_config') or guild.settings.get('welcome_message_config', {}).get('type', 'embed') == 'embed' %}checked{% endif %}
                        onchange="toggleMessageType()"
                    >
                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Embed (Rich Message)</span>
                </label>
                <label class="flex items-center">
                    <input
                        type="radio"
                        name="messageType"
                        value="plain"
                        id="messageTypePlain"
                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                        {% if guild and guild.settings.get('welcome_message_config', {}).get('type') == 'plain' %}checked{% endif %}
                        onchange="toggleMessageType()"
                    >
                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Plain Text</span>
                </label>
            </div>
        </div>

        <!-- Embed Configuration -->
        <div id="embedConfig" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Title
                </label>
                <input
                    type="text"
                    id="embedTitle"
                    placeholder="Welcome to the Server!"
                    value="{{ guild.settings.get('welcome_message_config', {}).get('embed', {}).get('title', 'Welcome to the Server!') if guild else 'Welcome to the Server!' }}"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Description
                </label>
                <textarea
                    id="embedDescription"
                    rows="2"
                    placeholder="Here's how to get started:"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >{{ guild.settings.get('welcome_message_config', {}).get('embed', {}).get('description', "Here's how to get started:") if guild else "Here's how to get started:" }}</textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Color
                </label>
                <select
                    id="embedColor"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    {% set current_color = guild.settings.get('welcome_message_config', {}).get('embed', {}).get('color', 'green') if guild else 'green' %}
                    <option value="green" {% if current_color == 'green' %}selected{% endif %}>Green</option>
                    <option value="blue" {% if current_color == 'blue' %}selected{% endif %}>Blue</option>
                    <option value="red" {% if current_color == 'red' %}selected{% endif %}>Red</option>
                    <option value="yellow" {% if current_color == 'yellow' %}selected{% endif %}>Yellow</option>
                    <option value="purple" {% if current_color == 'purple' %}selected{% endif %}>Purple</option>
                    <option value="orange" {% if current_color == 'orange' %}selected{% endif %}>Orange</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Fields (one per line, format: Field Name | Field Value)
                </label>
                <textarea
                    id="embedFields"
                    rows="4"
                    placeholder="Step 1: | Read the server rules in the rules channel.&#10;Step 2: | Check out some cool posts in the projects channel.&#10;Step 3: | Complete the Onboarding procedure to unlock the rest of the server."
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >{% if guild and guild.settings.get('welcome_message_config', {}).get('embed', {}).get('fields') %}{% for field in guild.settings.get('welcome_message_config', {}).get('embed', {}).get('fields', []) %}{{ field.name }} | {{ field.value }}
{% endfor %}{% else %}Step 1: | Read the server rules in the rules channel.
Step 2: | Check out some cool posts in the projects channel.
Step 3: | Complete the Onboarding procedure to unlock the rest of the server.{% endif %}</textarea>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                    Each line should be in the format: "Field Name | Field Value"
                </p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Footer
                </label>
                <input
                    type="text"
                    id="embedFooter"
                    placeholder="Enjoy your stay!"
                    value="{{ guild.settings.get('welcome_message_config', {}).get('embed', {}).get('footer', 'Enjoy your stay!') if guild else 'Enjoy your stay!' }}"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
            </div>
        </div>

        <!-- Plain Text Configuration -->
        <div id="plainConfig" class="space-y-4 hidden">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Message Content
                </label>
                <textarea
                    id="plainContent"
                    rows="8"
                    placeholder="Welcome to the Server!&#10;&#10;Here's how to get started:&#10;&#10;Step 1: Read the server rules in the rules channel.&#10;Step 2: Check out some cool posts in the projects channel.&#10;Step 3: Complete the Onboarding procedure to unlock the rest of the server.&#10;&#10;Enjoy your stay!"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >{{ guild.settings.get('welcome_message_config', {}).get('content', '') if guild else '' }}</textarea>
            </div>
        </div>

        <div class="mt-6">
            <button
                onclick="saveWelcomeMessage()"
                class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
                Save Welcome Message
            </button>
        </div>
    </div>

    <!-- Preview -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Message Preview</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
            This is how the welcome message will appear in Discord
        </p>

        <!-- Discord-style message preview -->
        <div class="bg-gray-100 dark:bg-gray-900 rounded-lg p-4">
            <div class="flex items-center mb-3">
                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-semibold">
                    B
                </div>
                <span class="ml-2 text-sm font-semibold text-gray-900 dark:text-white">{{ guild.guild_name if guild else 'Bot' }}</span>
                <span class="ml-2 text-xs bg-blue-600 text-white px-1.5 py-0.5 rounded">BOT</span>
            </div>

            <!-- Embed Preview -->
            <div id="embedPreview" class="bg-gray-50 dark:bg-gray-800 rounded p-4 border-l-4" style="border-color: #10b981;">
                <h3 id="previewTitle" class="text-lg font-bold text-gray-900 dark:text-white mb-2">Welcome to the Server!</h3>
                <p id="previewDescription" class="text-sm text-gray-700 dark:text-gray-300 mb-2">Here's how to get started:</p>
                <div id="previewFields" class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                    <div><strong>Step 1:</strong> Read the server rules in the rules channel.</div>
                    <div><strong>Step 2:</strong> Check out some cool posts in the projects channel.</div>
                    <div><strong>Step 3:</strong> Complete the Onboarding procedure to unlock the rest of the server.</div>
                </div>
                <p id="previewFooter" class="text-xs text-gray-500 dark:text-gray-400 mt-3">Enjoy your stay!</p>
            </div>

            <!-- Plain Text Preview -->
            <div id="plainPreview" class="hidden">
                <pre id="plainPreviewContent" class="text-sm text-gray-900 dark:text-white whitespace-pre-wrap font-sans">Welcome to the Server!

Here's how to get started:

Step 1: Read the server rules in the rules channel.
Step 2: Check out some cool posts in the projects channel.
Step 3: Complete the Onboarding procedure to unlock the rest of the server.

Enjoy your stay!</pre>
            </div>

            {% if guild and guild.settings.get('show_onboarding_button', True) %}
            <div class="mt-3">
                <button class="bg-green-600 text-white text-sm px-4 py-2 rounded hover:bg-green-700">
                    Complete Onboarding
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Welcome Message Settings -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Welcome Message Actions</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
            Manage the welcome message in your Discord channel
        </p>

        <!-- Message Actions -->
        <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg mb-6">
            <h3 class="text-sm font-medium text-gray-900 dark:text-white mb-3">Message Controls</h3>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">
                After editing the message content above, use these buttons to update the message in Discord.
            </p>
            <div class="flex gap-3">
                <button
                    onclick="updateWelcomeMessage()"
                    class="flex-1 px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    Update Existing Message
                </button>
                <button
                    onclick="replaceWelcomeMessage()"
                    class="flex-1 px-4 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500"
                >
                    Send/Replace Message
                </button>
            </div>
            <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                <p><strong>Update:</strong> Edits the existing message in place (faster, preserves message history)</p>
                <p><strong>Replace:</strong> Deletes old message and sends a new one (use if no message exists or if update fails)</p>
            </div>
        </div>

        <h3 class="text-md font-semibold text-gray-900 dark:text-white mb-3">Additional Settings</h3>

        <div class="space-y-4">
            <!-- Enable Welcome Messages -->
            <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                <label class="flex items-center justify-between cursor-pointer">
                    <div>
                        <h3 class="text-sm font-medium text-gray-900 dark:text-white">Enable Welcome Messages</h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            Automatically post welcome message when new members join
                        </p>
                    </div>
                    <input
                        type="checkbox"
                        id="welcome_enabled"
                        onchange="updateSetting('welcome_enabled', this.checked)"
                        class="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                        {% if guild and guild.settings.get('welcome_enabled', True) %}checked{% endif %}
                    >
                </label>
            </div>

            <!-- Show Onboarding Button -->
            <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                <label class="flex items-center justify-between cursor-pointer">
                    <div>
                        <h3 class="text-sm font-medium text-gray-900 dark:text-white">Show Onboarding Button</h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            Include a button in the welcome message for members to complete onboarding
                        </p>
                    </div>
                    <input
                        type="checkbox"
                        id="show_onboarding_button"
                        onchange="updateSetting('show_onboarding_button', this.checked)"
                        class="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                        {% if guild and guild.settings.get('show_onboarding_button', True) %}checked{% endif %}
                    >
                </label>
            </div>

            <!-- Delete Duplicate Messages -->
            <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                <label class="flex items-center justify-between cursor-pointer">
                    <div>
                        <h3 class="text-sm font-medium text-gray-900 dark:text-white">Single Message Mode</h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            Only keep one welcome message in the channel (delete duplicates)
                        </p>
                    </div>
                    <input
                        type="checkbox"
                        id="single_welcome_message"
                        onchange="updateSetting('single_welcome_message', this.checked)"
                        class="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                        {% if guild and guild.settings.get('single_welcome_message', True) %}checked{% endif %}
                    >
                </label>
            </div>
        </div>
    </div>

    <!-- Help Section -->
    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-blue-900 dark:text-blue-200 mb-2">Need Help?</h3>
        <p class="text-sm text-blue-700 dark:text-blue-300">
            The welcome system automatically posts a message in your designated channel when new members join. Make sure your bot has permission to send messages and embeds in the welcome channel. You can customize the message content and choose between embed or plain text format using the Message Content section above.
        </p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
async function loadChannels() {
    // Load channels from Discord
    try {
        const response = await fetch('/api/discord/channels');
        const data = await response.json();

        if (data.error || !data.channels || data.channels.length === 0) {
            // Show error and fall back to manual input
            document.getElementById('channelLoadingState').classList.add('hidden');
            document.getElementById('channelErrorState').classList.remove('hidden');
            document.getElementById('channelErrorMessage').textContent = data.error || 'No channels found';
        } else {
            // Populate dropdown with channels
            console.log('Loaded channels from Discord:', data.channels);
            console.log('Channel IDs:', data.channels.map(c => c.id));
            const select = document.getElementById('channelSelect');
            select.innerHTML = '<option value="">-- Select a channel --</option>';

            let currentCategory = null;
            for (const channel of data.channels) {
                // Add category header if changed
                if (channel.category !== currentCategory) {
                    if (channel.category) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = channel.category;
                        select.appendChild(optgroup);
                        currentCategory = channel.category;
                    } else {
                        currentCategory = null;
                    }
                }

                const option = document.createElement('option');
                option.value = channel.id;
                option.textContent = '# ' + channel.name;
                option.dataset.name = channel.name;

                if (currentCategory && channel.category === currentCategory) {
                    select.lastElementChild.appendChild(option);
                } else {
                    select.appendChild(option);
                }
            }

            // Pre-select current channel if exists
            {% if welcome_channel %}
            const currentChannelId = '{{ welcome_channel.channel_id }}';
            console.log('Trying to select channel:', currentChannelId);
            select.value = currentChannelId;
            console.log('Selected value:', select.value);
            if (!select.value) {
                // Try to find the option manually
                for (let option of select.options) {
                    if (option.value === currentChannelId) {
                        option.selected = true;
                        break;
                    }
                }
            }
            {% endif %}

            document.getElementById('channelLoadingState').classList.add('hidden');
            document.getElementById('channelSelectionState').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error loading channels:', error);
        document.getElementById('channelLoadingState').classList.add('hidden');
        document.getElementById('channelErrorState').classList.remove('hidden');
        document.getElementById('channelErrorMessage').textContent = 'Failed to load channels from Discord';
    }
}

async function saveChannel() {
    const select = document.getElementById('channelSelect');
    const channelId = select.value;

    if (!channelId) {
        alert('Please select a channel');
        return;
    }

    // Get channel name from selected option
    const selectedOption = select.options[select.selectedIndex];
    const channelName = selectedOption.dataset.name;

    try {
        const response = await fetch('/api/config/channel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                channel_id: channelId,  // Keep as string to preserve precision
                channel_type: 'welcome',
                name: channelName || null
            })
        });

        if (response.ok) {
            alert('Welcome channel configured successfully!');
            window.location.reload();
        } else {
            const error = await response.json();
            alert(`Error: ${error.detail || 'Failed to configure channel'}`);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error configuring channel');
    }
}

async function saveChannelManual() {
    const channelId = document.getElementById('channelIdInput').value;

    if (!channelId) {
        alert('Please enter a channel ID');
        return;
    }

    try {
        const response = await fetch('/api/config/channel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                channel_id: channelId,  // Keep as string to preserve precision
                channel_type: 'welcome',
                name: null
            })
        });

        if (response.ok) {
            alert('Welcome channel configured successfully!');
            window.location.reload();
        } else {
            const error = await response.json();
            alert(`Error: ${error.detail || 'Failed to configure channel'}`);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error configuring channel');
    }
}

async function updateSetting(key, value) {
    try {
        const response = await fetch('/api/config/setting', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                key: key,
                value: value
            })
        });

        if (response.ok) {
            console.log(`Setting ${key} updated to ${value}`);
            // Update status badge if welcome_enabled changed
            if (key === 'welcome_enabled') {
                window.location.reload();
            }
        } else {
            const error = await response.json();
            alert(`Error: ${error.detail || 'Failed to update setting'}`);
            // Revert checkbox
            document.getElementById(key).checked = !value;
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error updating setting');
        // Revert checkbox
        document.getElementById(key).checked = !value;
    }
}

function toggleMessageType() {
    const embedRadio = document.getElementById('messageTypeEmbed');
    const plainRadio = document.getElementById('messageTypePlain');
    const embedConfig = document.getElementById('embedConfig');
    const plainConfig = document.getElementById('plainConfig');
    const embedPreview = document.getElementById('embedPreview');
    const plainPreview = document.getElementById('plainPreview');

    if (embedRadio.checked) {
        embedConfig.classList.remove('hidden');
        plainConfig.classList.add('hidden');
        embedPreview.classList.remove('hidden');
        plainPreview.classList.add('hidden');
    } else {
        embedConfig.classList.add('hidden');
        plainConfig.classList.remove('hidden');
        embedPreview.classList.add('hidden');
        plainPreview.classList.remove('hidden');
    }

    updatePreview();
}

function updatePreview() {
    const messageType = document.querySelector('input[name="messageType"]:checked').value;

    if (messageType === 'plain') {
        // Update plain text preview
        const content = document.getElementById('plainContent').value;
        document.getElementById('plainPreviewContent').textContent = content || 'No content';
    } else {
        // Update embed preview
        const title = document.getElementById('embedTitle').value;
        const description = document.getElementById('embedDescription').value;
        const color = document.getElementById('embedColor').value;
        const footer = document.getElementById('embedFooter').value;
        const fieldsText = document.getElementById('embedFields').value;

        // Update title
        document.getElementById('previewTitle').textContent = title || 'No Title';

        // Update description
        const descElement = document.getElementById('previewDescription');
        if (description) {
            descElement.textContent = description;
            descElement.classList.remove('hidden');
        } else {
            descElement.classList.add('hidden');
        }

        // Update color
        const colorMap = {
            'green': '#10b981',
            'blue': '#3b82f6',
            'red': '#ef4444',
            'yellow': '#eab308',
            'purple': '#a855f7',
            'orange': '#f97316'
        };
        document.getElementById('embedPreview').style.borderColor = colorMap[color] || '#10b981';

        // Update fields
        const fieldsContainer = document.getElementById('previewFields');
        if (fieldsText.trim()) {
            const lines = fieldsText.split('\n');
            const fieldsHtml = lines
                .filter(line => line.trim())
                .map(line => {
                    const parts = line.split('|').map(p => p.trim());
                    if (parts.length >= 2) {
                        return `<div><strong>${parts[0]}</strong> ${parts[1]}</div>`;
                    }
                    return '';
                })
                .join('');
            fieldsContainer.innerHTML = fieldsHtml || '<div class="text-gray-500">No fields</div>';
            fieldsContainer.classList.remove('hidden');
        } else {
            fieldsContainer.classList.add('hidden');
        }

        // Update footer
        const footerElement = document.getElementById('previewFooter');
        if (footer) {
            footerElement.textContent = footer;
            footerElement.classList.remove('hidden');
        } else {
            footerElement.classList.add('hidden');
        }
    }
}

async function saveWelcomeMessage() {
    const messageType = document.querySelector('input[name="messageType"]:checked').value;
    const data = {
        type: messageType
    };

    if (messageType === 'plain') {
        data.content = document.getElementById('plainContent').value;
    } else {
        // Parse fields from textarea
        const fieldsText = document.getElementById('embedFields').value;
        const fields = [];

        if (fieldsText.trim()) {
            const lines = fieldsText.split('\n');
            for (const line of lines) {
                if (line.trim()) {
                    const parts = line.split('|').map(p => p.trim());
                    if (parts.length >= 2) {
                        fields.push({
                            name: parts[0],
                            value: parts[1],
                            inline: false
                        });
                    }
                }
            }
        }

        data.title = document.getElementById('embedTitle').value;
        data.description = document.getElementById('embedDescription').value;
        data.color = document.getElementById('embedColor').value;
        data.footer = document.getElementById('embedFooter').value;
        data.fields = fields;
    }

    try {
        const response = await fetch('/api/config/welcome-message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert('Welcome message updated successfully!');
            window.location.reload();
        } else {
            const error = await response.json();
            alert(`Error: ${error.detail || 'Failed to update welcome message'}`);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error updating welcome message');
    }
}

async function updateWelcomeMessage() {
    if (!confirm('Update the existing welcome message with the current configuration?')) {
        return;
    }

    try {
        const response = await fetch('/api/welcome/update-message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            alert('Welcome message updated successfully!');
        } else {
            const error = await response.json();
            alert(`Error: ${error.detail || 'Failed to update message'}`);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error updating welcome message');
    }
}

async function replaceWelcomeMessage() {
    if (!confirm('This will delete the old message and create a new one. Continue?')) {
        return;
    }

    try {
        const response = await fetch('/api/welcome/replace-message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            alert('Welcome message sent/replaced successfully!');
        } else {
            const error = await response.json();
            alert(`Error: ${error.detail || 'Failed to send/replace message'}`);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error sending/replacing welcome message');
    }
}

// Initialize the correct view on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load channels from Discord
    loadChannels();

    // Initialize message type toggle
    toggleMessageType();

    // Add event listeners for real-time preview updates
    document.getElementById('embedTitle').addEventListener('input', updatePreview);
    document.getElementById('embedDescription').addEventListener('input', updatePreview);
    document.getElementById('embedColor').addEventListener('change', updatePreview);
    document.getElementById('embedFooter').addEventListener('input', updatePreview);
    document.getElementById('embedFields').addEventListener('input', updatePreview);
    document.getElementById('plainContent').addEventListener('input', updatePreview);

    // Initial preview update
    updatePreview();
});
</script>
{% endblock %}
